<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>奇可智能打卡鐘查詢系統</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', "Microsoft JhengHei", Arial, sans-serif; background-color: #f5f7fa; margin:0; padding:0; }
.container { max-width: 700px; margin: 40px auto; padding: 30px; background: #fff; box-shadow: 0 8px 16px rgba(0,0,0,0.1); border-radius: 10px; position: relative; }
h2 { text-align:center; color:#333; margin-bottom:25px; }
label { font-weight:500; display:block; margin-bottom:5px; }
input, select, button { width:100%; padding:10px 15px; margin-bottom:15px; font-size:16px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
input:focus, select:focus { border-color:#4CAF50; outline:none; box-shadow:0 0 5px rgba(76,175,80,0.5); }
button { cursor:pointer; border:none; font-weight:600; transition:0.3s; }
#loginBtn, #cancelBtn { background:#1565C0; color:white; }
#loginBtn:hover, #cancelBtn:hover { background:#0D47A1; }
#queryBtn, #downloadBtn { background:#4CAF50; color:white; }
#queryBtn:hover, #downloadBtn:hover { background:#388E3C; }
#logoutBtn { position:absolute; top:20px; right:20px; width:2cm; height:1.3cm; background:orange; color:white; font-size:16px; border-radius:6px; }
#logoutBtn:hover { opacity:0.8; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; border-radius:6px; overflow:hidden; }
th, td { border:1px solid #ddd; padding:8px; text-align:center; }
th { background-color:#4CAF50; color:white; font-weight:500; }
tr:nth-child(even){background-color:#f2f2f2;}
.pagination { text-align:center; margin-top:10px; }
.pagination button { width:auto; margin:0 5px; padding:5px 10px; font-size:14px; }

.date-buttons { display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
.date-buttons button { flex:1; background:#2196F3; color:white; }
.date-buttons button:hover { background:#1976D2; }

/* 手機版樣式 */
@media (max-width: 600px) { 
  .container { padding:20px; } 
  input, select, button { font-size:18px; } 
  .date-buttons { flex-direction:column; }
  .date-buttons button { padding:15px; font-size:18px; width:100%; }

  /* 調整登出按鈕與標題間距 */
  #logoutBtn {
      position: relative;
      display: block;
      margin: 0 auto 20px auto; /* 上下間距 */
      width: 80%;
      height: 50px;
  }
  h2#companyTitle {
      margin-top: 10px;
      margin-bottom: 30px; /* 與表單間距 */
  }
}
</style>
</head>
<body>
<div class="container">
  <!-- 登入頁 -->
  <form id="loginForm">
    <h2>管理者登入</h2>
    <label>帳號：</label>
    <input type="text" id="username" required>
    <label>密碼：</label>
    <input type="password" id="password" required>
    <div style="display:flex; gap:10px;">
      <button type="button" id="loginBtn">登錄</button>
      <button type="button" id="cancelBtn">取消</button>
    </div>
  </form>

  <!-- 查詢頁 -->
  <div id="querySection" style="display:none;">
    <button id="logoutBtn">登出</button>
    <h2 id="companyTitle" style="margin-bottom:40px; text-align:center;">出勤打卡紀錄查詢與下載</h2>

    <form id="queryForm">
      <label>姓名（可留空）：</label>
      <select id="name"><option value="">全部（不指定）</option></select>

      <div class="date-buttons">
        <button type="button" class="quickDateBtn" data-type="lastMonth">上月</button>
        <button type="button" class="quickDateBtn" data-type="today">今日</button>
        <button type="button" class="quickDateBtn" data-type="week">本週</button>
        <button type="button" class="quickDateBtn" data-type="month">本月</button>
      </div>

      <label>開始日期：</label>
      <input type="date" id="startDate">
      <label>結束日期：</label>
      <input type="date" id="endDate">

      <label>下載格式：</label>
      <select id="format"><option value="csv">CSV</option><option value="xlsx">XLSX</option></select>

      <div style="display:flex; gap:10px;">
        <button type="button" id="queryBtn">查詢</button>
        <button type="button" id="downloadBtn">下載</button>
      </div>
    </form>

    <label>快速搜尋：</label>
    <input type="text" id="quickSearch" placeholder="輸入姓名或其他欄位關鍵字">
    <div id="tableContainer"></div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
const apiBase = 'https://script.google.com/macros/s/AKfycbwzsBpCnqeRGxerNhR-DtnSMF_hZd3_brEYOI2Lnz4ge2srQnuDptkIXkMphoAL4hPJhg/exec';
let usernameGlobal = '';
let companyGlobal = '';
let currentData = [];
let filteredData = [];
let currentPage = 1;
const pageSize = 20;

const today = new Date();
const todayStr = today.toISOString().split('T')[0];
const startInput = document.getElementById('startDate');
const endInput = document.getElementById('endDate');
startInput.value = todayStr;
endInput.value = todayStr;
startInput.setAttribute('max', todayStr);
endInput.setAttribute('max', todayStr);

function toLocalYMD(date){
  const yyyy = date.getFullYear();
  const mm = ("0"+(date.getMonth()+1)).slice(-2);
  const dd = ("0"+date.getDate()).slice(-2);
  return `${yyyy}-${mm}-${dd}`;
}

function formatDateToYMD(dateStr){
  const date = new Date(dateStr);
  const yyyy = date.getFullYear();
  const mm = ("0"+(date.getMonth()+1)).slice(-2);
  const dd = ("0"+date.getDate()).slice(-2);
  return `${yyyy}/${mm}/${dd}`;
}

// 登錄
document.getElementById('loginBtn').addEventListener('click', async ()=>{
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!username || !password){ alert("請輸入帳號與密碼"); return; }

  try{
    const res = await fetch(`${apiBase}?mode=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
    const json = await res.json();
    if(json.success){
      usernameGlobal = username;
      companyGlobal = json.company || '奇可';
      document.getElementById('loginForm').style.display='none';
      document.getElementById('querySection').style.display='block';
      document.getElementById('companyTitle').textContent = `${companyGlobal} 出勤打卡紀錄查詢與下載`;
      await fetchNames();
      await fetchData(formatDateToYMD(todayStr), formatDateToYMD(todayStr), '');
    } else { alert("帳號或密碼錯誤"); }
  } catch(err){ console.error(err); alert("登入失敗，請稍後再試"); }
});

document.getElementById('cancelBtn').addEventListener('click', ()=>{
  document.getElementById('username').value='';
  document.getElementById('password').value='';
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  document.getElementById('querySection').style.display='none';
  document.getElementById('loginForm').style.display='block';
  document.getElementById('username').value='';
  document.getElementById('password').value='';
  usernameGlobal=''; companyGlobal='';
});

async function fetchNames(){
  try{
    const res = await fetch(`${apiBase}?mode=names&username=${encodeURIComponent(usernameGlobal)}`);
    const json = await res.json();
    const nameSelect=document.getElementById('name');
    json.names.forEach(name=>{
      const option=document.createElement('option');
      option.value=name; option.textContent=name;
      nameSelect.appendChild(option);
    });
  }catch(err){ console.warn("姓名載入失敗", err); }
}

async function fetchData(startDate, endDate, name){
  let url = `${apiBase}?username=${encodeURIComponent(usernameGlobal)}&startDate=${startDate}&endDate=${endDate}`;
  if(name) url += `&name=${encodeURIComponent(name)}`;
  const res = await fetch(url);
  const data = await res.json();
  if(!data.length){
    alert("查無資料");
    document.getElementById('tableContainer').innerHTML='';
    document.getElementById('pagination').innerHTML='';
    filteredData=[];
    currentData=[];
    return;
  }
  currentData=data; filteredData=data; currentPage=1; renderTablePage();
}

function renderTablePage(){
  const startIndex = (currentPage-1)*pageSize;
  const pageData = filteredData.slice(startIndex,startIndex+pageSize);
  let html=`<table><tr>`;
  if(pageData.length===0){
    html+='<th>查無資料</th></tr></table>';
    document.getElementById('tableContainer').innerHTML=html;
    document.getElementById('pagination').innerHTML='';
    return;
  }
  Object.keys(pageData[0]).forEach(k=>html+=`<th>${k}</th>`);
  html+='</tr>';
  pageData.forEach(row=>{
    html+='<tr>'; Object.values(row).forEach(v=>html+=`<td>${v}</td>`); html+='</tr>';
  });
  html+='</table>';
  document.getElementById('tableContainer').innerHTML=html;
  renderPagination();
}

function renderPagination(){
  const totalPages = Math.ceil(filteredData.length/pageSize);
  let html='';
  if(currentPage>1) html+=`<button onclick="goPage(${currentPage-1})">上一頁</button>`;
  html+=`第 ${currentPage} / ${totalPages} 頁`;
  if(currentPage<totalPages) html+=`<button onclick="goPage(${currentPage+1})">下一頁</button>`;
  document.getElementById('pagination').innerHTML=html;
}
function goPage(p){ currentPage=p; renderTablePage(); }

document.getElementById('quickSearch').addEventListener('input', e=>{
  const keyword=e.target.value.trim().toLowerCase();
  filteredData = keyword ? currentData.filter(row=>Object.values(row).some(v=>String(v).toLowerCase().includes(keyword))) : currentData;
  currentPage=1; renderTablePage();
});

document.getElementById('queryBtn').addEventListener('click', async ()=>{
  const name=document.getElementById('name').value;
  const startDate=formatDateToYMD(startInput.value);
  const endDate=formatDateToYMD(endInput.value);
  await fetchData(startDate,endDate,name);
});

document.getElementById('downloadBtn').addEventListener('click', ()=>{
  if(!filteredData.length) return alert("沒有資料可下載！");
  const data=filteredData;
  const name=document.getElementById('name').value;
  const format=document.getElementById('format').value;
  const startDate=formatDateToYMD(startInput.value);
  const endDate=formatDateToYMD(endInput.value);
  const fileName=`${companyGlobal}_${name||'所有人'}_${startDate}_至_${endDate}.${format}`;

  if(format==="csv"){
    const csv = convertToCSV(data);
    downloadBlob(new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"}),fileName);
  } else {
    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.json_to_sheet(data);
    XLSX.utils.book_append_sheet(wb,ws,"打卡紀錄");
    downloadBlob(new Blob([XLSX.write(wb,{bookType:"xlsx",type:"array"})],{type:"application/octet-stream"}),fileName);
  }
});

function convertToCSV(data){
  const keys=Object.keys(data[0]);
  const lines=[keys.join(",")];
  data.forEach(row=>lines.push(keys.map(k=>`"${row[k]||''}"`).join(",")));
  return lines.join("\n");
}
function downloadBlob(blob,fileName){
  const link=document.createElement('a');
  link.href=URL.createObjectURL(blob);
  link.download=fileName;
  link.click();
}

// 快速日期按鈕
document.querySelectorAll('.quickDateBtn').forEach(btn=>{
  btn.addEventListener('click', async e=>{
    const type=e.target.dataset.type;
    const now=new Date();
    let start='', end=toLocalYMD(now);
    const name = document.getElementById('name').value;

    if(type==='today'){ start=end; }
    else if(type==='week'){ 
      const firstDayWeek = new Date(now);
      firstDayWeek.setDate(now.getDate() - now.getDay());
      start = toLocalYMD(firstDayWeek);
    }
    else if(type==='month'){
      const firstDayMonth = new Date(now.getFullYear(), now.getMonth(), 1);
      start = toLocalYMD(firstDayMonth);
    }
    else if(type==='lastMonth'){
      const firstDayLastMonth = new Date(now.getFullYear(), now.getMonth()-1, 1);
      const lastDayLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);
      start = toLocalYMD(firstDayLastMonth);
      end = toLocalYMD(lastDayLastMonth);
    }

    startInput.value = start;
    endInput.value = end;
    await fetchData(formatDateToYMD(startInput.value), formatDateToYMD(endInput.value), name);
  });
});
</script>
</body>
</html>










