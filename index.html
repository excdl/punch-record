<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>奇可智能打卡鐘查詢系統</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', "Microsoft JhengHei", Arial, sans-serif; background-color: #f5f7fa; margin:0; padding:0; }
.container { position: relative; max-width: 700px; margin: 20px auto; padding: 30px; background: #fff; box-shadow: 0 8px 20px rgba(0,0,0,0.15); border-radius: 12px; }
h2 { text-align:center; color:#333; margin-bottom:20px; font-size:1.5rem; }
label { font-weight:500; display:block; margin-bottom:5px; }
input, select, button { width:100%; padding:12px 15px; margin-bottom:15px; font-size:16px; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; transition: all 0.2s; }
input:focus, select:focus { border-color:#4CAF50; outline:none; box-shadow:0 0 8px rgba(76,175,80,0.4); }
button { cursor:pointer; border:none; background:linear-gradient(90deg,#4CAF50,#45A049); color:white; font-weight:600; transition:0.3s; }
button:hover { background:linear-gradient(90deg,#45A049,#4CAF50); }
#logoutBtn { position:absolute; top:15px; right:15px; background:#d9534f; padding:8px 14px; border-radius:8px; font-size:14px; font-weight:500; }
.quick-buttons { display:flex; gap:10px; flex-wrap:wrap; margin:10px 0; }
.quick-buttons button { flex:1; min-width:80px; }

/* 表格樣式 */
.table-wrapper { overflow-x:auto; max-height:400px; position:relative; }
table { border-collapse: collapse; width:100%; min-width:600px; }
th, td { border:1px solid #ddd; padding:10px; text-align:center; white-space: nowrap; font-size:14px; }
th { background-color:#4CAF50; color:white; font-weight:500; position: sticky; top:0; z-index:1; cursor:pointer; }
tr:nth-child(even){background-color:#f9f9f9;}
.pagination { text-align:center; margin-top:10px; }
.pagination button { width:auto; margin:0 5px; padding:6px 12px; font-size:14px; border-radius:6px; }

/* 手機優化 */
@media (max-width: 500px) {
  .container { padding:20px; margin:10px; }
  h2 { font-size:1.3rem; }
  input, select, button { font-size:16px; padding:10px 12px; }
  th, td { font-size:12px; padding:8px; }
  .pagination button { padding:5px 10px; font-size:12px; }
}
</style>
</head>
<body>
<div class="container">

  <button id="logoutBtn" style="display:none;">登出</button>

  <!-- 登入畫面 -->
  <h2 id="loginTitle">管理者登入</h2>
  <form id="loginForm">
    <label>帳號：</label>
    <input type="text" id="username" required>
    <label>密碼：</label>
    <input type="password" id="password" required>
    <div style="display:flex; gap:10px;">
      <button type="button" id="loginBtn">登錄</button>
      <button type="button" id="cancelBtn">取消</button>
    </div>
  </form>

  <!-- 查詢畫面 -->
  <div id="querySection" style="display:none;">
    <h2 id="companyTitle">打卡紀錄查詢</h2>
    <form id="queryForm" onsubmit="return false;">
      <label>姓名（可留空）：</label>
      <select id="name"><option value="">全部（不指定）</option></select>

      <label>開始日期：</label>
      <input type="date" id="startDate">
      <label>結束日期：</label>
      <input type="date" id="endDate">

      <div class="quick-buttons">
        <button type="button" id="btnToday">今天</button>
        <button type="button" id="btnWeek">本週</button>
        <button type="button" id="btnMonth">本月</button>
        <button type="button" id="btnAll">全部</button>
      </div>

      <label>下載格式：</label>
      <select id="format"><option value="csv">CSV</option><option value="xlsx">XLSX</option></select>

      <div style="display:flex; gap:10px;">
        <button type="button" id="queryBtn">查詢</button>
        <button type="button" id="downloadBtn">下載</button>
      </div>
    </form>

    <label>快速搜尋：</label>
    <input type="text" id="quickSearch" placeholder="輸入姓名或其他欄位關鍵字">

    <div class="table-wrapper">
      <div id="tableContainer"></div>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>
</div>

<script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
const apiBase = "https://script.google.com/macros/s/AKfycby3e3wPfRGB93Gjj2K1U4RFaXHu5_ubcVi7cRl0HG6mlV3GdI9oCK7xdQlM1k7YgYHB/exec";
let usernameGlobal="", companyName="", currentData=[], filteredData=[], currentPage=1, sortField="", sortAsc=true;
const pageSize=20;
const today = new Date().toISOString().split('T')[0];
const startInput=document.getElementById("startDate");
const endInput=document.getElementById("endDate");
startInput.value=today; endInput.value=today; startInput.max=today; endInput.max=today;
function formatDateToYMD(d){ if(!d) return ""; const date=new Date(d); return `${date.getFullYear()}/${("0"+(date.getMonth()+1)).slice(-2)}/${("0"+date.getDate()).slice(-2)}`; }

// ===== 登入 =====
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const u=document.getElementById("username").value.trim();
  const p=document.getElementById("password").value.trim();
  if(!u||!p){ alert("請輸入帳號與密碼"); return; }
  const res=await fetch(`${apiBase}?mode=login&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`);
  const json=await res.json();
  if(!json.success){ alert("帳號或密碼錯誤"); return; }
  usernameGlobal=u; companyName=json.company||"";
  document.getElementById("loginForm").style.display="none";
  document.getElementById("loginTitle").style.display="none";
  document.getElementById("logoutBtn").style.display="block";
  document.getElementById("companyTitle").innerText=`${companyName} 打卡紀錄查詢`;
  document.getElementById("querySection").style.display="block";
  await fetchNames();
  await fetchData(formatDateToYMD(today),formatDateToYMD(today),"");
});

// ===== 登出 =====
document.getElementById("logoutBtn").addEventListener("click", ()=>{
  usernameGlobal=""; companyName=""; currentData=[]; filteredData=[];
  document.getElementById("name").innerHTML='<option value="">全部（不指定）</option>';
  document.getElementById("tableContainer").innerHTML=""; document.getElementById("pagination").innerHTML="";
  document.getElementById("quickSearch").value="";
  document.getElementById("querySection").style.display="none";
  document.getElementById("logoutBtn").style.display="none";
  document.getElementById("loginTitle").style.display="block";
  document.getElementById("loginForm").style.display="block";
  alert("您已成功登出");
});

// ===== 取得姓名 =====
async function fetchNames(){
  const res=await fetch(`${apiBase}?mode=names&username=${encodeURIComponent(usernameGlobal)}`);
  const json=await res.json();
  const sel=document.getElementById("name");
  json.names.forEach(n=>{ let opt=document.createElement("option"); opt.value=n; opt.innerText=n; sel.appendChild(opt); });
}

// ===== 抓資料 =====
async function fetchData(start,end,name){
  let url=`${apiBase}?username=${encodeURIComponent(usernameGlobal)}&startDate=${start}&endDate=${end}`;
  if(name) url+=`&name=${encodeURIComponent(name)}`;
  const res=await fetch(url);
  const data=await res.json();
  if(!data.length){ alert("查無資料"); document.getElementById("tableContainer").innerHTML=""; document.getElementById("pagination").innerHTML=""; currentData=[]; filteredData=[]; return; }
  currentData=data; filteredData=data; currentPage=1; sortField=""; sortAsc=true; renderTablePage();
}

// ===== 渲染表格 =====
function renderTablePage(){
  if(sortField){ filteredData.sort((a,b)=>sortAsc ? (a[sortField]||"").toString().localeCompare(b[sortField]||"") : (b[sortField]||"").toString().localeCompare(a[sortField]||"")); }
  const st=(currentPage-1)*pageSize; const pageData=filteredData.slice(st,st+pageSize);
  let html="<table><tr>";
  if(pageData.length===0){ html+="<th>查無資料</th></tr></table>"; document.getElementById("tableContainer").innerHTML=html; document.getElementById("pagination").innerHTML=""; return; }
  Object.keys(pageData[0]).forEach(k=>html+=`<th onclick="sortTable('${k}')">${k}${sortField===k?(sortAsc?" ▲":" ▼"):""}</th>`); html+="</tr>";
  pageData.forEach(r=>{ html+="<tr>"; Object.values(r).forEach(v=>html+=`<td>${v}</td>`); html+="</tr>"; });
  html+="</table>"; document.getElementById("tableContainer").innerHTML=html; renderPagination();
}

// ===== 排序 =====
function sortTable(field){
  if(sortField===field) sortAsc=!sortAsc; else { sortField=field; sortAsc=true; }
  renderTablePage();
}

// ===== 分頁 =====
function renderPagination(){ let total=Math.ceil(filteredData.length/pageSize); let html=""; if(currentPage>1) html+=`<button onclick="goPage(${currentPage-1})">上一頁</button>`; html+=`第 ${currentPage} / ${total} 頁`; if(currentPage<total) html+=`<button onclick="goPage(${currentPage+1})">下一頁</button>`; document.getElementById("pagination").innerHTML=html; }
function goPage(p){ currentPage=p; renderTablePage(); }

// ===== 快速搜尋 =====
document.getElementById("quickSearch").addEventListener("input", e=>{ let k=e.target.value.trim().toLowerCase(); filteredData=k?currentData.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(k))):currentData; currentPage=1; renderTablePage(); });

// ===== 查詢 =====
document.getElementById("queryBtn").addEventListener("click", async ()=>{ const name=document.getElementById("name").value; await fetchData(formatDateToYMD(startInput.value),formatDateToYMD(endInput.value),name); });

// ===== 下載 =====
document.getElementById("downloadBtn").addEventListener("click", ()=>{
  if(!filteredData.length) return alert("沒有資料可下載");
  const format=document.getElementById("format").value; const name=document.getElementById("name").value;
  const fileName=`${name||"所有人"}_${startInput.value||"全部"}_至_${endInput.value||"全部"}.${format}`;
  if(format==="csv"){ const csv=convertToCSV(filteredData); downloadBlob(new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"}),fileName); }
  else { const wb=XLSX.utils.book_new(); const ws=XLSX.utils.json_to_sheet(filteredData); XLSX.utils.book_append_sheet(wb,ws,"打卡紀錄"); downloadBlob(new Blob([XLSX.write(wb,{bookType:"xlsx",type:"array"})]),fileName); }
});
function convertToCSV(data){ const keys=Object.keys(data[0]); let lines=[keys.join(",")]; data.forEach(r=>lines.push(keys.map(k=>`"${r[k]||''}"`).join(","))); return lines.join("\n"); }
function downloadBlob(blob,fileName){ const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=fileName; a.click(); }

// ===== 快速日期 =====
document.getElementById("btnToday").addEventListener("click", async ()=>{ startInput.value=today; endInput.value=today; await fetchData(formatDateToYMD(today),formatDateToYMD(today),document.getElementById("name").value); });
document.getElementById("btnWeek").addEventListener("click", async ()=>{
  let d=new Date(); let day=d.getDay()||7; let monday=new Date(d); monday.setDate(d.getDate()-day+1); startInput.value=monday.toISOString().split("T")[0]; endInput.value=today;
  await fetchData(formatDateToYMD(startInput.value),formatDateToYMD(today),document.getElementById("name").value);
});
document.getElementById("btnMonth").addEventListener("click", async ()=>{
  let first=today.substring(0,8)+"01"; startInput.value=first; endInput.value=today;
  await fetchData(formatDateToYMD(first),formatDateToYMD(today),document.getElementById("name").value);
});
document.getElementById("btnAll").addEventListener("click", async ()=>{
  startInput.value=""; endInput.value=""; await fetchData("", "", document.getElementById("name").value);
});
</script>
</body>
</html>



